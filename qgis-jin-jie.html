<!DOCTYPE html>
<html class="no-js" lang="zh">

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?edacc2fd8b368948e096e3036935a648";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<head>
    <title>CycleUser</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" id="responsive-style-css"  href='/theme/css/style.css' type="text/css" media="all" />
    <link rel="stylesheet" id="responsive-style-css"  href='/theme/css/highlight.css' type="text/css" media="all" />
</head>

<body id="index" class="blog">
<div id="container" class="hfeed">
    <header id="header" >
        <div id="logo">
                <h1><img src="/theme/image/default-logo.png" width="300" height="100" alt="CycleUser" />
                CycleUser</h1>
        </div> <!-- /#logo-->
        <nav id="menu" class="main-nav"><ul class="menu">
            <li  class="active"><a href="https://blog.cycleuser.org">Homepage</a></li>
            <li  class="active"><a href="https://blog.cycleuser.org/categories.html">Categories</a></li>
            <li  class="active"><a href="https://blog.cycleuser.org/tags.html">Tags</a></li>
            <li  class="active"><a href="https://blog.cycleuser.org/archives.html">Archives</a></li>
            <li  class="active"><a href="https://blog.cycleuser.org/about.html">About</a></li>

        </ul></nav><!-- /#menu -->
    </header>
    <section id="wrapper" class="clearfix">
        <section id="content" class="grid col-620" >
                <section class="breadcrumb-list">
<a href=".">Blog</a> ›<a href="category/qgis.html">QGIS</a> ›QGIS 进阶
                </section>


<section id="post" class="post hentry">
    <header>
    <h2 class="post-title" >QGIS 进阶</h2>
    
    <div class="post-meta">
        <span class="meta-prep">Post in</span>
        <abbr class="date" title="2022-01-12T23:59:00+08:00"> 
            <a href="./archive/2022/1月/index.html">周三 12 一月 2022 </a>
        </abbr>
        <span class="meta-prep"> |Tags</span>
                <a href="./tag/gis.html">GIS</a>
                <a href="./tag/qgis.html">QGIS</a>
                <a href="./tag/python.html">Python</a>
                <a href="./tag/learning.html">Learning</a>
                <a href="./tag/book.html">Book</a>
        <!-- TOBE COMMENTS -->
    </div>
    </header>
    <div class="post-entry">
        <p><a href="https://courses.spatialthoughts.com/advanced-qgis.html">本文英文原版地址</a></p>
<h3>地理信息系统流程自动化和高级可视化技术</h3>
<h4>英文原作者：Ujaval Gandhi</h4>
<h4>中文翻译：CycleUser</h4>
<h1>导论</h1>
<p>本课程关注于地理信息系统工作留的自动化。本章你将学到更有生产力的技术，来创建美观的可视化，并解决复杂的空间分析问题。本课程尤其适合已经使用QGIS的人来提升进阶技能。</p>
<p>本文涉及的内容如下：</p>
<ul>
<li>处理框架-算法、批处理和建模器</li>
<li>动画演示时间序列数据</li>
<li>从航拍图像创建立体透视图</li>
<li>高级表达式，实现快速数据编辑、模糊匹配等功能</li>
</ul>
<p>进行练习之前，可以先了解一下关于QGIS的基础知识。</p>
<p><a href="https://pan.baidu.com/s/1AXe1IrbJHADJnMfrikw7RA">查看幻灯片提取码: 6npb</a></p>
<h1>软件</h1>
<p>本课程使用的软件是QGIS长期支持版本（LTR）3.16。</p>
<p>可以参考<a href="https://courses.spatialthoughts.com/install-qgis-ltr.html">QGIS-LTR 安装指南</a>。</p>
<h1>获取数据包</h1>
<p>本课程的样例要用到多种数据集。所有需要的图层、项目文件等等，都在下面的<code>advanced_qgis.zip</code>文件中。建议解压缩后将其放在<code>Downloads</code>文件夹下。</p>
<p><a href="https://pan.baidu.com/s/1FZa2J06f70zKsDR_T9N0cw">下载数据包 提取码: 5r2l </a></p>
<h1>处理框架（Processing Framework）</h1>
<p>QGIS 2.0 开始引入了一个新概念，叫做处理框架（Processing Framework）。处理框架提供了在QGIS那运行原生或者第三方算法来处理数据的环境。这也是现在用于在QGSI那进行任何类型数据处理和分析的推荐方法，可以进行特征选择、属性修改和图层保存等等，当然这些也可以通过其他渠道来实现。不过使用处理框架会让这些工作更加有效率、更快速，还不容易出错。</p>
<p>处理框架包含下面这些不同的元素，一起配合工作。</p>
<ul>
<li><strong>处理工具箱 Processing Toolbox</strong>: 包含各种独立工具和算法，通过供应者和功能进行分类</li>
<li><strong>批处理界面 Batch Processing Interface</strong>: 允许任何处理工具可以同时对多个图层执行</li>
<li><strong>图形化建模器 Graphical Modeler</strong>: 允许用户定义工作流然后将多个处理步骤链接起来，使用拖拽机制（drag-and-drop mechanism）</li>
<li><strong>历史管理器 History Manager</strong>: 记录存储算法进行的所有操作，允许用户重现过去的分析步骤</li>
<li><strong>结果查看器 Results Viewer</strong>: 查看数据表和图表等算法产生的非空间输出结果</li>
</ul>
<p><a href="https://pan.baidu.com/s/1zkdlVaheZ3pf6GN4q8dMKQ">查看幻灯片 提取码: nvbs</a></p>
<p>接下来就分章节来练习一下这些模块。
（译者注：由于QGIS默认界面是英文的，后文中这几个模块的英文在文中就不再翻译了，直接用原文。）</p>
<h2>处理工具箱（Processing Toolbox）</h2>
<p>Processing Toolbox 可以在最顶层菜单<strong>Processing → Toolbox</strong>中找到。其中有几百个现成的算法。通过提供者<em>Providers</em>进行分类。由QGIS开发者创建的工具就在原生QGIS提供者（<strong>Native</strong> QGIS provider）分组中。处理框架（Processing Framework）提供了一种简单方式来集成其他软件和库，比如GDAL、GRASS和SAGA等等。QGIS的插件也可以通过在工具箱里面的处理算法增加新功能。</p>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/toolbox_algorithms.png"></p>
<h3>为何要使用处理算法（Processing Algorithms）</h3>
<ul>
<li>经过妥善测试和严格实现</li>
<li>主要用C++编写，运行速度比其他替代品更快</li>
<li>可以在后台运行长处理，不影响QGIS的前台使用</li>
<li>多线程算法可以充分利用多核心处理器，提高性能表现</li>
<li>健壮地处理无效几何体</li>
<li>可以查看运算过程并取消</li>
<li>可以在所有特征或所选特征上运行</li>
</ul>
<h3>查看默认设置</h3>
<p>在设置中可以控制所见的处理工具提供者。处理选项菜单（Processing Options menu）也提供了框架设置的精细调整方式。</p>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/processing_settings1.png"></p>
<p>强烈推荐修改一下默认设置，启用选项<em>Prefer output filename for layer names</em>。这确保当你使用批处理的时候，得到的各个图层是唯一的。</p>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/processing_settings2.png"></p>
<h3>练习: 找到州内的国家高速公路长度</h3>
<p>该练习展示如何使用纯处理工作流解决多步骤的空间数据分析问题，以及QGIS中算法的丰富性，可以进行之前需要插件或者更复杂步骤的复杂操作。</p>
<p>接下来从OpenStreetMap地图提取印度卡纳塔克（Karnataka）的道路信息。州的行政边界信息可以从DataMeet获得。</p>
<ol>
<li>浏览文件夹定位到<code>karnataka.gpkg</code>，拖拽<code>karnataka</code>、<code>karnataka_districts</code>和<code>karnataka_major_roads</code>到QGIS地图画布中。</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/karnataka1.png"></p>
<ol>
<li>图层<code>karnataka_major_roads</code>包含了所有的主要道路，其中有国家高速公路、省级高速公路、主干道路等等。选择该图层，然后使用快捷键<strong>F6</strong>打开属性表格（attribute table）。</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/karnataka2.png"></p>
<ol>
<li>你会注意到<code>ref</code>这一列由关于道路的相关信息。由于本次练习中只需要国家高速公路，可以使用这列信息来只提取相关的道路段。</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/karnataka3.png"></p>
<ol>
<li>你可以使用通过表达式选择（<em>Select by expression</em>）工具，导出所选特征作为新图层，然后继续处理。但处理工具箱（Processing Toolbox）提供了一个更简单的无缝工作流，可以搜索算法<strong>Extract by expression</strong>。</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/karnataka4.png"></p>
<ol>
<li>输入下面的表达式来提取特征，其中<code>ref</code>的开头字母为<code>NH</code>。</li>
</ol>
<blockquote>
<p>这里使用的其实就是正则表达式（<em>Regular Expression，缩写为RegEx</em>）来进行特定模式的匹配。正则表达式非常强大，可以用于很多复杂的数据筛选操作。 <a href="https://medium.com/factory-mind/regex-tutorial-a-simple-cheatsheet-by-examples-649dc1c3f285">基础细节可以参考这个链接</a>。 </p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">regexp_match</span><span class="p">(</span><span class="s">&quot;ref&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&#39;</span><span class="o">^</span><span class="n">NH</span><span class="p">&#39;)</span>
</code></pre></div>

<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/karnataka5.png"></p>
<ol>
<li>你会在图层面板（Layers Panel）得到一个名为<code>Matching Features</code>的新图层。接下来想要计算其中每个道路段的长度。可以使用内置算法<strong>Add geometry attributes</strong>。</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/karnataka6.png"></p>
<ol>
<li>源图层的地理坐标参考系（Geographic CRS）是EPSG:4326。但对此分析来说，要使用米或者千米来作为单位。算法提供了方便的选项来使用椭球体<strong>Elliposidal</strong>数学来计算距离，这对于地理坐标参考系的图层很适合。</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/karnataka7.png"></p>
<ol>
<li>添加了<code>length</code>值域的新图层就会被添加在图层面板中来。这个域的值的单位是米。然后转换成千米。这可以使用QGIS的域计算器<strong>Field Calculator</strong> 来增加一个新域（field）。这个方法绝对颗星，但还有一个更推荐的处理框架方法。搜索并打开<strong>Field Calculator</strong> 处理算法，然后输入下面的表达式。</li>
</ol>
<div class="highlight"><pre><span></span><code>&quot;length&quot;/1000
</code></pre></div>

<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/karnataka8.png"></p>
<ol>
<li>图层面板添加了带有域<code>length_km</code>的新图层。然后就是要解决问题了。只需要将新增图层中<code>length_km</code>的所有值加起来就可以了。使用<strong>Basic Statistics for Fields</strong>算法即可。</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/karnataka9.png"></p>
<ol>
<li>在<em>Basic Statistics for Fields</em>对话框中，选择<code>Calculated</code>作为输入层<em>Input layer</em>，选择<code>length_km</code>作为<em>Field to calculate statistics on</em>。点击<em>Run</em>运行。</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/karnataka10.png"></p>
<ol>
<li>得到的结果是对列进行不同统计的数据表。由于结果不是图层，就要在<em>Results Viewer</em>中查看。图层面板中会包含一个HTML文件，包含的是统计值。<strong>Sum</strong>包含的就是该州内的所有国家高速路的长度。</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/karnataka11.png"></p>
<blockquote>
<p>你觉得结构怎么样？可能并不是很理想，因为OpenStreetMap数据库可能会有丢失的路径或者可能有分类错误。但应该和<a href="https://morth.nic.in/sites/default/files/PragatiKiNayiGati/pdf/karnataka.pdf">官方统计</a>还是很接近的。</p>
</blockquote>
<ol>
<li><code>Calculated</code>就是最终图层，也是一个临时的记忆层。将其保存到磁盘，以备后续使用。这个图层中有很多数据都是我们用不上的，所以可以删除掉一些列，然后字啊保存。经典方法是打开编辑模式然后在属性表格里面使用<em>Delete Column</em>按钮。如果你要重命名或者重新编码某个域，就需要一个插件。不过现在，我们已经可以使用<strong>Refactor Fields</strong>这样的处理算法来一次行进行加减、重命名和重新编码特定域。删除掉不需要的域，然后将结果存储为图层<code>national_highways</code>，保存在<code>karnataka.gpkg</code>中。</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/karnataka12.png"></p>
<ol>
<li>图层面板中新增了<code>national_highways</code>图层。这样就达到了本练习的目的，但还可以继续探索一点，如果可以将结果拆解成一个更小的行政单元。然后再计算一下每个小的行政单元内的国家高速公路长度。</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/karnataka13.png"></p>
<ol>
<li>在<code>karnataka_districts</code>图层中有行政区划信息，但在<code>national_highways</code>中并没有。要在道路图层中添加行政区划名称信息，需要运行空间连接（spatial-join）。这要使用<strong>Join attributes by Location</strong>算法来实现。选择<code>national_highways</code>作为输入层，然后和<code>karnataka_districts</code>图层进行一对一连接。只选择<strong>DISTRICT</strong>域添加到输出上。</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/karnataka14.png"></p>
<ol>
<li>新的<code>Joined layer</code>图层就有了交叉的行政区划名存储在<strong>DISTRICT</strong>域中了。如果你用过之前版本的QGIS，你可能还记得当时需要调用插件Group Stats来实现这个功能。但现在可以通过内置的<strong>Statistic by Categories</strong>算法来实现了。选择<code>Joined layer</code>作为输入向量图层<em>Input vector layer</em>，选择<strong>length_km</strong>作为<em>Field to calculate statistics on</em>。选择<strong>DISTRICT</strong>作为<em>Field(s) with Categories</em>。</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/karnataka15.png"></p>
<ol>
<li>这个算法的输出结果是一个数据表，其中包含了对每个行政区在<code>length_km</code>列上的各种统计值。其中<strong>Sum</strong> 列的值就是各区的国家高速路总长度了。</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/karnataka16.png"></p>
<p>注意，这里我们所做的数据处理、空间分析和统计分析，都只是使用了处理算法，是一个快速、可重现、符合直觉的工作流。</p>
<h3>了解更多</h3>
<p>想要对处理工具箱（Processing Toolbox）中其他上千种工具有进一步了解，可以参考下面的视频。</p>
<p><a href="https://www.youtube.com/watch?v=Tkqj3VCxrqI"><img alt="Video" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/processing_tour_qgisna.jpg"></a></p>
<h3>The Locator Bar</h3>
<p>To take your processing experience to the next-level, you can use the built-in <strong>Locator Bar</strong>. At the bottom-left of QGIS main window, there is a universal search bar that can do keyword-search across layers, settings, processing algorithms and more. You can open the locator bar using the keyboard shortcut <strong>Ctrl+K</strong>.</p>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/locator1.png"></p>
<p>I find that rather than clicking-around the processing toolbox, you can just use the locator bar to search and open the algorithms. Type <strong>Ctrl+K</strong>, followed by <strong>a</strong> (to restrict search to algorithms), followed by a <strong>space</strong> and <strong>a few characters</strong>. Use the arrow keys to select and press <strong>Enter</strong> to open the algorithm.</p>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/locator.png"></p>
<p><a href="https://courses.spatialthoughts.com/images/advanced_qgis/locator.gif">View Animated GIF ↗</a></p>
<h3>In-place Editing</h3>
<p>Processing algorithms are designed to take inputs and produce outputs. The default behavior is to create a new layer after each operation. This is useful for many workflows, especially in an enterprise setting, where you may not have the ability to edit the source data. If your algorithms are altering the source data, that also means that the workflows cannot be reproduced easily. So you would want a setup where the algorithms read from source data and create modified outputs.</p>
<p>An exception to this workflow is when you are doing data editing. When your workflow involves creating new features or editing them - creating a new layer for every edit is undesirable. A recent <a href="https://north-road.com/edit-features-in-place-using-qgis-spatial-operations-campaign/">QGIS crowd-funding campaign</a> added the ability for processing algorithms to modify the features in-place and this functionality is available out-of-the-box in QGIS now.</p>
<ol>
<li>Load the <strong>basic_network_analysis</strong> project from the data package. This project contains a street network for Washington DC from DCGISopendata where the arrows display the digitizing direction of the line segments. You can click the <strong>Edit Features In-Place</strong> button in the processing toolbox to use algorithms that support this functionality. Once this mode is activated, processing algorithms will modify the selected features in the chosen layer instead of creating a new layer.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/inplace1.png"></p>
<ol>
<li>Select a line segment and run the <strong>Reverse line direction</strong> algorithm. The algorithm will enable editing on the layer, perform the operation and overwrite the existing feature with a segment in the reverse direction. You will see that the arrow rendering is now in the opposite direction.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/inplace2.png"></p>
<p><a href="https://courses.spatialthoughts.com/images/advanced_qgis/inplace2.gif">View Animated GIF ↗</a></p>
<h2>Batch Processing</h2>
<p>So far we have run the algorithm on 1 layer at a time. But each processing algorithm can also be run in a <strong>Batch</strong> mode on multiple inputs. This provides an easy way to process large amounts of data and automate repetitive tasks.</p>
<p>The batch processing interface can be invoked by right-clicking any processing algorithm and choosing <strong>Execute as Batch Process</strong>.</p>
<h3>练习: Clip multiple layers to a polygon</h3>
<p>We will take multiple country-level data layers and use the batch processing operation to clip them to a state polygon in a single operation.</p>
<ol>
<li>Open the <strong>batch_processing</strong> project.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/batch01.png"></p>
<ol>
<li>Next, right-click on the <code>state boundary</code> layer, and click <strong>Zoom to Layer</strong>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/batch02.png"></p>
<ol>
<li>Now that we have centered on our area of interest, under the <strong>Processing</strong> menu and select <strong>toolbox</strong>. Now in <em>Processing Toolbox</em>, search for <strong>clip</strong>, under <strong>Vector overlay → Clip</strong> right-click and select <strong>Execute as Batch Process..</strong>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/batch03.png"></p>
<ol>
<li>In the <em>Batch processing - Clip</em> dialog box, click the <em>Autofill…</em> under the <em>Input layer</em> column and choose <em>Select from Open Layers..</em>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/batch04.png"></p>
<ol>
<li>Select all data layers except <code>state_boundary</code> and click <strong>OK</strong>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/batch05.png"></p>
<ol>
<li>Under <em>Overlay Layer</em> select the <strong>state_boundary</strong> layer. Then click the drop-down button near <em>Autofill…</em> and choose to <strong>Fill Down</strong>. This will auto-populate all the <em>Overlay Layer</em> with the <code>state_boundary</code> layer.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/batch06.png"></p>
<ol>
<li>Under <em>Clipped</em>, select <em>…</em> button to add the output filenames.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/batch07.png"></p>
<ol>
<li>In the <em>Save File</em> dialog box, enter the <em>File name</em> as <code>clipped_</code>. This is just the prefix of the name that you will auto-complete in the next step. Select <strong>GPKG files (.gpkg)</strong> in <em>Save as type</em>. Click <strong>Save</strong>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/batch08.png"></p>
<ol>
<li>Next, you will be prompted to choose the <em>Autofill settings</em>. Select to <strong>Fill with parameter values</strong> as the <em>Autofill mode</em>, and <strong>Input layer</strong> as the <em>Parameter to use</em>. Click <strong>OK</strong>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/batch09.png"></p>
<ol>
<li>Note that each row has a different file name now. The output file name is the result of the chosen prefix and the autofill settings. Make sure the <em>Load layers on completion</em> box is checked and click <em>Run</em>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/batch10.png"></p>
<ol>
<li>The resulting clipped layers will be added to the <em>Layers panel</em>. Turn off all previous layers in the Layers panel to see the results clearly. We can now combine all the clipped layers into a single <em>geopackage</em> file for ease of sharing. Now in the <em>Processing Toolbox</em>, search and select the <strong>Package Layers</strong>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/batch11.png"></p>
<ol>
<li>In the <em>Package Layers</em> dialog box, in <em>Input layers</em> choose all the clipped layers and in <em>Destination GeoPackage</em> click <em>…</em> and select <strong>Save to File…</strong>. Then save the file as <code>clipped.gpkg</code>. Click <strong>Run</strong></li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/batch12.png"></p>
<ol>
<li>Now a new <code>clipped.gpkg</code> geopackage layer will be created with all the clipped layers in it.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/batch13.png"></p>
<h2>Graphical Modeler</h2>
<p>GIS Workflows typically involve many steps - with each step generating intermediate output that is used by the next step. If you change the input data or want to tweak a parameter, you will need to run through the entire process again manually. Fortunately, Processing Framework provides a graphical modeler that can help you define your workflow and run it with a single invocation. You can also run these workflows as a batch over a large number of inputs.</p>
<h3>练习: Find the hotspots of piracy incidents</h3>
<p>National Geospatial-Intelligence Agency’s Maritime Safety Information portal provides a shapefile of all incidents of maritime piracy in the form of Anti-shipping Activity Messages. We can create a density map by aggregating the incident points over a global hexagonal grid.</p>
<p>The steps needed to create a hex-bin layer suitable for visualization is as follows:</p>
<ul>
<li>Reproject the input to an equal-area projection</li>
<li>Create a global hexagonal grid layer</li>
<li>Select all grids that intersect with at least 1 point</li>
<li>Count points within each grid</li>
</ul>
<p>We will now learn how to build a model that runs the above processing steps in a single workflow.</p>
<ol>
<li>Open the <strong>maritime_piracy</strong> project.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler1.png"></p>
<ol>
<li>Launch the modeler from <strong>Processing → Graphical Modeler</strong></li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler2.png"></p>
<ol>
<li>In the Processing Modeler dialog, locate the <em>Model Properties</em> panel. Enter <code>piracy_hexbin</code> as the Name of the model and <code>projects</code> as the Groups. Note that there is a History panel in the bottom left, which keeps track of all the work done in Model Builder. Click the Save button.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler3.png"></p>
<ol>
<li>Save the model as <code>piracy_hexbin.model3</code>. Also, check the folder in which it is being saved. <em>Processing → models</em>, from this location QGIS will read the model by default.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler4.png"></p>
<ol>
<li>Now, we can start building a graphical model of our processing pipeline. The Processing modeler dialog contains a left-hand panel and the main canvas. On the left-hand panel, locate the Inputs panel listing various types of input data types. Scroll down and select the <strong>+ Vector Layer</strong> input. Drag it to the canvas.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler5.png"></p>
<ol>
<li>Enter <strong>Input Points</strong> as the <em>Description</em> and <strong>Point</strong> as the <em>Geometry type</em>. This input represents the piracy incidents point layer.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler6.png"></p>
<ol>
<li>Next, drag another <strong>+ Vector Layer</strong> input to the canvas. Enter <strong>Base Layer</strong> as the <em>Description</em> and <strong>Polygon</strong> as the <em>Geometry type</em>. This input represents the natural earth global land layer in which we will use as the extent of the grid layer.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler7.png"></p>
<ol>
<li>As we are generating a global hexagonal grid, we can ask the user to supply us with the grid size as an input instead of hard-coding it as part of our model. This way, the user can quickly experiment with different grid sizes without changing the model at all. Select a <strong>+ Number</strong> input and drag it to the canvas. Enter <strong>Grid Size</strong> as the Parameter name, <strong>Integer</strong> as the Number Type, <strong>200000</strong> as Default Value, and click OK.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler8.png"></p>
<ol>
<li>Now that we have our user inputs defined, we are ready to add processing steps. All of the processing algorithms are available to you under the <em>Algorithms</em> tab. The first step in our pipeline will be to reproject the base layer to the Project CRS. Search for the <strong>Reproject layer</strong> algorithm and drag it to the canvas.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler9.png"></p>
<ol>
<li>In the <em>Reproject layer</em> dialog, select <strong>Base Layer</strong>, by clicking the button under the <em>Input Layer</em> and select <strong>Model Input</strong> as the <em>Input layer</em>. Check the Use <strong>project CRS</strong> as the <em>Target CRS</em>. Click OK.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler10.png"></p>
<ol>
<li>In the Processing Modeler canvas, you will notice a connection appear between the <code>+ Base Layer</code> input and the <code>Reproject layer</code> algorithm. This connection indicates the flow of our processing pipeline. The next step is to create a hexagonal grid. Now search for the <strong>Create grid</strong> algorithm and drag it to the canvas.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler11.png"></p>
<ol>
<li>In the Create grid dialog, choose <strong>Hexagon (polygon)</strong> as the <em>Grid type</em>. Select <strong>Algorithm Output</strong> by clicking the button under <em>Grid extent</em> and choose <strong>‘Reprojected’ from the algorithm ‘Reproject Layer’</strong> as the Grid extent.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler12.png"></p>
<ol>
<li>Select <strong>Model input</strong> by clicking the button under <em>Horizontal Spacing</em> and choose <strong>Grid Size</strong> as the <em>Horizontal Spacing</em>. Click OK.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler13.png"></p>
<ol>
<li>Select <strong>Model input</strong> by clicking the button under <em>Vertical Spacing</em> and choose <strong>Grid Size</strong> as the <em>Vertical Spacing</em>. Click OK.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler14.png"></p>
<ol>
<li>At this point, we have a global hexagonal grid. The grid spans the full extent of the base layer, including land areas and places where there are no points. Let us filter out those grid polygons where there are no input points. Search for <strong>Extract by location</strong> algorithm and drag it to the canvas.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler15.png"></p>
<ol>
<li>Select <strong>Algorithm Output</strong> from the icon below <em>Extract features from</em>. Now choose <strong>‘Grid’ from the algorithm ‘Generate Grid’</strong>. Click <strong>…</strong> at the right end.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler16.png"></p>
<ol>
<li>Select <strong>Intersect</strong> by clicking the button, as Where the features(geometric predicate). And click the triangle button to go back to the previous window. Now click OK.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler17.png"></p>
<ol>
<li>Select <strong>Model input</strong> by clicking the button under <em>By comparing to the features from</em> and choose <strong>Input Points</strong> as <em>By comparing to the features from</em>. Click OK.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler18.png"></p>
<ol>
<li>Now, we have only those grid polygons that contain some input points. To aggregate these points, we will use <strong>Count points in polygon</strong> algorithm. Search and drag it to the canvas.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler19.png"></p>
<ol>
<li>Select <strong>Algorithm Output</strong> by clicking the button under <em>Polygons</em> and choose <strong>‘Extracted (location)’ from algorithm ‘Extract by location’</strong> for <em>Polygons</em>. Now, Select <strong>Model Input</strong> by clicking the button under <em>Points</em> and choose <strong>Input Points</strong> for <em>Points</em>. Type <strong>NUMPOINTS</strong> in <strong>Count field name</strong>. At the bottom, name the Count output layer as <strong>Aggregated</strong>. Click OK.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler20.png"></p>
<ol>
<li>The model is now complete. Click the <em>Save</em> button. If the model is saved, then a green notification will pop on the screen.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler21.png"></p>
<ol>
<li>Switch to the main QGIS window. You can find your newly created model in the <em>Processing Toolbox</em> under <strong>Models → projects → piracy_hexbin</strong>. Double-click to run the model.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler22.png"></p>
<ol>
<li>Our <em>Base Layer</em> is the <code>ne_10m_land</code> and the <em>Input Points</em> layer is <code>ASAM_events</code>. The Grid Size needs to be specified in the units of the selected CRS. Enter <code>100000</code> as the Grid Size. Grid size is in the unit of the current CRS, which is meters. Click Run to start the processing pipeline. Once the process finishes, click Close.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler23.png"></p>
<ol>
<li>You will see a new layer <code>Aggregated</code> loaded as the result of the model. As you explore, you will notice the layer contains an attribute called <em>NUMPOINTS</em> containing the number of piracy incidents points contained within that grid feature. Let’s style this layer to display this information better. Click the <em>Open Layer Styling Panel</em> button from the <em>Layers panel.</em> Select <strong>Graduated</strong> symbology and <strong>NUMPOINTS</strong> as the Column. Click the dropdown next to the Color ramp and select the <strong>Viridis</strong> ramp. Click the dropdown again and select <strong>Invert Color Ramp</strong> to reverse the order of color. The Graduated symbology will divide the values in the selected column into distinct classes and assign a different color to each of the classes. Select <strong>Natural Breaks (Jenks)</strong> as the Mode and click <strong>Classify</strong>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler24.png"></p>
<ol>
<li>We will use a clever trick to make the visualization better. We can use QGIS variables to set the edges of the hexagon with a slightly darker shade of the fill color. Click on the <strong>Symbol</strong>. Click <strong>Simple Fill</strong>. Click the <strong>Data defined override</strong> button next to <strong>Stroke color</strong> and select <strong>Edit</strong>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler25.png"></p>
<ol>
<li>Enter the following expression to set the stroke color to 30% darker than the fill color and click OK. The map rendering will change to a much smoother visualization.</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="n">darker</span><span class="p">(</span><span class="w"> </span><span class="nv">@symbol_color</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">130</span><span class="p">)</span>
</code></pre></div>

<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/modeler26.png"></p>
<h3>Challenge: Improve the model</h3>
<p>Can you change the model so that instead of entering the grid size in meters, the user can enter the size in kilometers?</p>
<blockquote>
<p>Hint: The <strong>Create Grid</strong> algorithm expects the size in meters, so you will have to convert the input to meters.</p>
</blockquote>
<h3>Spatial Indexing</h3>
<p>When you ran your model, you may have noticed a warning message <strong>No spatial index exists for the input layer, performance will be severely degraded</strong>. This is because certain spatial queries make use of a spatial index and QGIS warns you when having a spatial index can speed up your operations. PostGIS documentation has a good <a href="https://postgis.net/workshops/postgis-intro/indexing.html">overview of spatial indexes</a> and why they are important.</p>
<p>You can compare a <em>spatial index</em> to a book <em>index</em>. When you want to search for a particular term, rather than scanning each page sequentially, you can speed up your search by looking up the index and directly going to the pages where the word appears. Spatial indexes work in similarly. You spent the effort once to create the index and all subsequent operations can make use of it. When you create a spatial index, each feature’s bounding box is used to establish its relationship with other features. This is stored alongside the dataset and can be used by algorithms. When trying to determine spatial relationships, the algorithms speed-up the look-up using the following <em>two-pass</em> method:</p>
<ul>
<li>Step 1: Use the spatial index to determine which target features’ bounding boxes intersect with the source feature’s bounding box. Since the spatial index already has computed this - this is very fast. The result is a list of candidate features.</li>
<li>Step 2: Now that there is a small subset of candidate features, iterate over them and use their full geometry to evaluate exact intersections.</li>
</ul>
<p>For large datasets, this approach helps reduce the processing time significantly.</p>
<p><a href="https://docs.google.com/presentation/d/1K1lR1JfonxGbmj8rCIVln_WkbWv6-tOYTYHAEJKAiw4/edit?usp=sharing"><img alt="View Presentation" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/spatial_indexing.png"></a></p>
<p><a href="https://docs.google.com/presentation/d/1K1lR1JfonxGbmj8rCIVln_WkbWv6-tOYTYHAEJKAiw4/edit?usp=sharing">查看幻灯片</a></p>
<p>QGIS has built-in tools to create and use spatial indexes. Let’s see how we can create a spatial index for a layer and use it in our model.</p>
<ol>
<li>Double click on the <code>piracy_hexbin</code> model from <em>Processing Toolbox</em>, select <strong>ne_10m_land</strong> as <em>Base Layer</em>, <strong>200000</strong> as <em>Grid size</em> and <strong>ASAM_events</strong> as <em>Inputs Points</em>. Click Run.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/index01.png"></p>
<ol>
<li>Switch to <em>Log</em>, and note down the execution time of the model. In this instance we got <em>34.80 seconds</em> (The exact time will vary depending on your computer configuration). Also note that it prompts a warning <em>No spatial index exists for input layer, performance will be severely degraded</em>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/index02.png"></p>
<ol>
<li>To create spatial index right-click the <strong>Aggregated</strong> layer and select <em>Properties</em>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/index03.png"></p>
<ol>
<li>In the <em>Layer Properties</em> dialog, switch to the <em>Source</em> tab. You will see the <em>Create Spatial Index</em> button. This button indicates that this layer does not currently have a spatial index. Click that button to create a spatial index. But we will use a better and more scalable way. Click <strong>OK</strong> and close the <em>Layer Properties</em> dialog.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/index04.png"></p>
<ol>
<li>Go to <strong>Processing → Toolbox</strong>. Search for the algorithm <strong>Vector general → Create spatial index</strong> and double-click to launch it.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/index05.png"></p>
<ol>
<li>Select <strong>Aggregated</strong> layer as the <em>Input layer</em> and click <em>Run</em>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/index06.png"></p>
<ol>
<li>Creating a spatial index is usually a fast operation. Once the algorithm finishes, right-click on the <strong>Aggregated</strong> layer and select <em>Properties</em>. Switch to the <em>Source</em> tab and you will see that the button has now changed to <em>Spatial Index Exists</em> - indicating that the layer now has a spatial index.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/index07.png"></p>
<ol>
<li>While creating a spatial index on a layer like this is useful, it is even more powerful to have the spatial index created during the execution of our model. We will see how to add the spatial index creation step in our model. Right-click the <code>piracy_hexbin</code> model and select <em>Edit Model…</em>. Search <strong>Create spatial index</strong> in <em>Algorithms</em> tab and drag it to the model canvas.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/index08.png"></p>
<ol>
<li>Choose <strong>Algorithm output</strong> from the button below <em>Input Layer</em>, and select <strong>“Grid” from algorithm “Create Grid”.</strong> Click OK.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/index09.png"></p>
<ol>
<li>You will see that the newly added <code>Create spatial index</code> algorithm is connected to the <code>Create grid</code> algorithm. But the workflow should be, <strong>Create grid → Create spatial index → Extract from location</strong>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/index10.png"></p>
<ol>
<li>Right-click the <code>Extract by location</code> layer and select <em>Edit</em>. In <em>Extract features from</em> select <strong>“Indexed Layer” from algorithm “Create spatial index”</strong>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/index11.png"></p>
<ol>
<li>Now you will see the model diagram updated and the connection changed between the <code>Create Grid</code> and <code>Extract by location</code> layer. Click <em>Save model</em>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/index12.png"></p>
<ol>
<li>Now return to the main canvas and select <code>piracy_hexbin</code> model.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/index13.png"></p>
<ol>
<li>Select <strong>ne_10m_land</strong> as <em>Base Layer</em>, <strong>200000</strong> as <em>Grid size</em> and <strong>ASAM_events</strong> as <em>Inputs Points</em>. Click Run.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/index14.png"></p>
<ol>
<li>In this instance we got <em>3.39 seconds</em> (The exact time will vary depending on your computer configuration). Also, note that it has executed 5 algorithms which is including creating the spatial index.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/index15.png"></p>
<h3>Conditional Branching</h3>
<p>A key feature introduced in QGIS 3.14 was the ability for models to have a conditional branch. This allows models to check for a condition and execute a different part of the model based on the output of the condition. This is equivalent to <em>If/Else statements</em> in a programming language.</p>
<p>Let us develop a <em>Conditional branch</em> in the <code>piracy_hexbin</code> model. We will add a new check-box input <em>Use Spatial Index</em> - that allows the user to specify whether to use a spatial index in the model. We will add a conditional branch that takes the following actions:</p>
<ul>
<li>If the <em>Use Spatial Index</em> option is selected, the model will create a spatial index for the grid layer and use it in the subsequent steps.</li>
<li>
<p>If the option is not selected, the model will proceed without generating a spatial index.</p>
</li>
<li>
<p>Right-click the <code>piracy_hexbin</code> model and select <strong>Edit Model…</strong>.</p>
</li>
</ul>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch01.png"></p>
<ol>
<li>Search for <strong>+Boolean</strong> in <em>Inputs</em> tab and drag to canvas.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch02.png"></p>
<ol>
<li>Give <em>Description</em> as <strong>Use Spatial Index</strong>, leave <strong>Checked</strong> unticked. Click <strong>OK</strong>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch03.png"></p>
<ol>
<li>Now, search for <strong>Conditional branch</strong> in <em>Algorithms</em> tabs and drag to canvas.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch04.png"></p>
<ol>
<li>Click the Add button and select the Expression Dialog button.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch05.png"> 6. All the model output and intermediate layers will be displayed in Bold characters, double click in <strong>usespatialindex</strong>. It will add the variable <code>@usespatialindex</code> as the expression. Click <em>OK</em>.</p>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch06.png"></p>
<ol>
<li>Now, in <em>Branch Name</em> type <strong>Use Spatial Index</strong>. We will add another branch now. Click the <em>Add</em> button and enter the <em>Branch Name</em> as <strong>Don’t Use Spatial Index</strong>. Since this is the opposite condition, we can use the expression <code>NOT @usespatialindex</code> Click <em>OK</em>.</li>
</ol>
<blockquote>
<p>Make sure to hit the <em>Enter</em> key after typing the <em>Branch Name</em>. The input may not be saved if you forget to do so.</p>
</blockquote>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch07.png"></p>
<ol>
<li>We have 2 branches in the model. Let’s connect them to appropriate algorithms. Double click on <code>Create spatial index</code> algorithm in model canvas and click <em>…</em> next to <em>Dependencies.</em></li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch08.png"></p>
<ol>
<li>Choose <strong>Condition “Use Spatial Index” from algorithm “Conditional branch”</strong> and click <strong>OK</strong>. The <em>Use Spatial Index</em> branch is now ready. Let’s build the other branch.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch09.png"></p>
<ol>
<li>Search for <strong>Extract by location</strong> in <em>Algorithms</em> tab and drag to canvas.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch10.png"></p>
<ol>
<li>In the <em>Description</em> type <strong>Extract by location (No Spatial Index)</strong>. Choose <em>Algorithm Output</em> in <em>Extract features from</em> and select <strong>“Grid” from algorithm “Create grid”</strong>. Click <em>…</em> next to <em>Dependencies</em>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch11.png"></p>
<ol>
<li>Choose <strong>Condition “Dont use Spatial Index” from algorithm “Conditional branch”</strong>. Click <strong>OK</strong>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch12.png"></p>
<ol>
<li>Similarly in <em>Extract by location</em> using <em>Spatial Index</em> change the description to <strong>Extract by location (Spatial Index)</strong>. Both the branches will be executed according to the user selection whether to use the spatial index or not. The next step is to update the the <em>Count points in polygon</em> algorithm to use the appropriate output. Double-click on the algorithm box.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch13.png"></p>
<ol>
<li>Under <em>Polygons</em> change <em>Algorithm output</em> to <em>Pre-calculated Value</em>, then press the <em>Expression</em> button.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch14.png"></p>
<ol>
<li>In the <em>Expression Dialog</em>, we need to select output from any one of the <em>Extract by location</em> algorithms based on the user condition of <code>@usespatialindex</code>. We can use the <code>if</code> condition to return a layer based on user input. Use the expression below. Remember to pick the variables from the list and double-click them to enter them in your expression. If you had named the algorithms or input differently, the variable names will be different for you. Click <strong>OK</strong>.</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="nv">@usespatialindex</span><span class="w"> </span><span class="p">,</span><span class="w">  </span>
<span class="w">    </span><span class="nv">@Extract_by_location__Spatial_Index__OUTPUT</span><span class="w"> </span><span class="p">,</span>
<span class="w">    </span><span class="nv">@Extract_by_location__No_Spatial_Index__OUTPUT</span><span class="p">)</span><span class="w"> </span>
</code></pre></div>

<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch15.png"></p>
<ol>
<li>Now click … in <em>Dependencies</em>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch16.png"></p>
<ol>
<li>Check <code>Extract by location (Spatial Index)</code> and <code>Extract by location (No Spatial Index)</code> and click <strong>OK</strong>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch17.png"></p>
<ol>
<li>Now that the model is completed, click <strong>Zoom full</strong> button to view the model. Let us save the model click <strong>Save model</strong> button.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch18.png"></p>
<ol>
<li>Now in the <em>Processing toolbox</em>, under that <strong>Models → projects → piracy_hexbin</strong> model will be available. Double click to execute it.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch19.png"></p>
<ol>
<li>In the <em>Base Layer</em> select <strong>ne_10m_land</strong>, <em>Grid size</em> as <strong>100000</strong>, and <em>Input points</em> as <strong>ASAM_events</strong>, check <em>Use Spatial Index</em> and click <strong>Run</strong>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch20.png"></p>
<ol>
<li>Switch to <em>Log</em>, we can notice the <em>Create spatial index</em> algorithm is activated, and the total time of execution is 7.41 seconds.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch21.png"></p>
<ol>
<li>Now switch to <em>Parameters</em>, un-check the <em>Use Spatial Index</em> and click <strong>Run</strong>. tab.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch22.png"></p>
<ol>
<li>Switch to the <em>Log</em>, we can notice the <em>No spatial index exists for input layer, performance will be severely degraded</em> warning get displayed, and the execution took 78.897 seconds.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/conditionalBranch23.png"></p>
<h3>Enabling Reproducible Workflows</h3>
<ol>
<li>To ensure that you are always able to reproduce your results, it is recommended to bundle the model in your project. The modeler interface has a button <strong>Save model in project</strong> that will embed the model in your QGIS project file.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/reproducibleWorkflows01.png"></p>
<ol>
<li>Once the model is embedded, Whenever you open the project, the model will be available to the user under the <strong>Project models</strong> in the Processing Toolbox.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/reproducibleWorkflows02.png"></p>
<ol>
<li>Now, lets save this project in <code>martime_piracy.gpkg</code> geopackage. Click <strong>Project → Save To → GeoPackage…</strong>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/reproducibleWorkflows03.png"></p>
<ol>
<li>In the <em>Save project to GeoPackage</em> dialog box, click … to browse to martime_piracy geopackage.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/reproducibleWorkflows04.png"></p>
<ol>
<li>Enter project name as <code>martime_piracy</code> and click <strong>OK</strong>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/reproducibleWorkflows05.png"></p>
<ol>
<li>Now in <em>Browser</em>, under <code>martime_piracy.gpkg</code> the project is saved. You now have just 1 GeoPackage file that contains all your input layers, styles, project and models. Sharing this 1 file will enable anyone to reproduce your output using the embedded model and layers.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/reproducibleWorkflows06.png"></p>
<h1>2D Animations</h1>
<p>Time is an important component of many spatial datasets. Along with location information, time providers another dimension for analysis and visualization of data. If you are working with a dataset that contains timestamps or have observations recorded at multiple time-steps, you can easily visualize it using the <strong>Temporal Controller</strong> in QGIS 3.14 or above.</p>
<h2>练习: Create a GIF showing changes in piracy hotspots over time</h2>
<p>We will continue to work with the maritime piracy dataset. First, we will create a heatmap visualization and then animate the heatmap to show how the piracy hot-spots have changed over the past 2 decades.</p>
<ol>
<li>Open the <strong>maritime_piracy</strong> project from the data package. There are thousands of incidents and it is difficult to determine with more piracy. Rather than individual points, a better way to visualize this data is through a heatmap. Select the <code>ASAM_events</code> layers and click the <strong>Open the layer Styling Panel</strong> button in the Layers panel. Click the <strong>Single symbol</strong> drop-down.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/2d01.png"></p>
<ol>
<li>In the renderer selection drop-down, select <strong>Heatmap</strong> renderer. Next, select the <strong>Viridis</strong> color ramp from the Color ramp selector. Adjust the Radius value to <strong>5.0.</strong> At the bottom, expand the <em>Layer Rendering</em> section and adjust the opacity to <strong>75.0%</strong>. This gives a nice visual effect of the hotspots with the land layer below.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/2d02.png"></p>
<ol>
<li>Now let’s animate this data to show the yearly map of piracy incidents. Right click on <code>ASAM_event</code> layer, and choose <em>Properties.</em></li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/2d03.png"></p>
<ol>
<li>In the layer properties dialog box, select the <em>Temporal</em> tab and enable it by clicking the checkbox.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/2d04.png"></p>
<ol>
<li>The source data contains an attribute <code>dateofocc</code> - representing the date on which the incident took place. This is the field that will be used to determine the points that are rendered for each time period. Select <strong>Single Field with Data/Time</strong> in <em>Configuration</em> Drop down menu, <strong>dateofocc</strong> as Field. Click <em>OK</em>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/2d05.png"></p>
<ol>
<li>Now a <em>Clock symbol</em> will appear next to the layer name. Click on the <strong>Temporal Control Panel</strong> (Clock icon) from Map Navigation Toolbar.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/2d06.png"></p>
<ol>
<li>Click on the <em>Animated Temporal Navigation</em> (play icon).</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/2d07.png"></p>
<ol>
<li>By default, the date range is set to the current date. Click <em>Set to Full Range</em> button to set the date range from the dataset.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/2d08.png"></p>
<ol>
<li>Now the data will be set to <code>2000-01-02</code> to <code>2018-01-01</code>. We want to create an animation showing yearly changes to the hotspot. Set the <em>Step</em> to <strong>years</strong>. Click <em>play</em> button to start rendering.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/2d09.png"></p>
<ol>
<li>It will be useful to add a label to the animation showing the date of the animation frame being displayed. We can use the <em>Title Decoration</em> to place that label. Go to <strong>View → Decorations → Title Label Decorations.</strong> Click the checkbox to enable it and then the <strong>Insert an Expression</strong> button.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/2d10.png"></p>
<ol>
<li>Enter the following expression to display the year and click <em>OK</em>.</li>
</ol>
<p><code>format_date(@map_start_time, 'yyyy-MM-dd')</code></p>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/2d11.png"></p>
<ol>
<li>Select font size as <strong>25</strong>, set background color as <strong>white.</strong> In placement choose <strong>Bottom Right.</strong> Now click OK.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/2d12.png"></p>
<p><a href="https://courses.spatialthoughts.com/images/advanced_qgis/2d12.gif">View Animated GIF ↗</a></p>
<ol>
<li>Once the parameters are set accordingly, the date will displayed on the map. To export these as images and convert them as GIF select the <strong>Export Animation</strong> (save icon) in the Temporal controller window.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/2d13.png"></p>
<ol>
<li>Choose the directory to save the images and select the <code>ne_10_land</code> for map extent.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/2d14.png"></p>
<ol>
<li>Once the export finishes, you will see PNG images for each year in the output directory. Now let’s create an animated GIF from these images. There are many options for creating animations from individual image frames. We like [<a href="https://ezgif.com/maker">ezgif.com</a>] for an easy and online tool. Visit the site and click Choose Files and select all the .png files. You may want to sort the images by Type to allow easy bulk selection of only .png files. Once selected, click the Upload and make a GIF! button.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/2d15.png"></p>
<h2>Challenge: Improve the animation</h2>
<p>You will notice that for each frame of the animation, the year is displayed at the top-center. But instead of the full date and time, let’s change it to display the year that the map represents. Also, place the copyright info at the bottom right. The output should look something like below.</p>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/2d16.png"></p>
<p><a href="https://courses.spatialthoughts.com/images/advanced_qgis/2d16.gif">View Animated GIF ↗</a></p>
<h1>3D Animations</h1>
<p>Recent versions of QGIS include native support for 3D data. Using this feature, you can easily view, explore and animate 3D elevation data. Note that your computer must have a supported graphics card for this feature to work.</p>
<h2>练习: Create a 3D Flythrough</h2>
<p>We will work with a 5m Digital Elevation Model (DEM) of Denali peak in Alaska and create an animation showing a 3D visualization of the dataset.</p>
<ol>
<li>Open the <strong>denali</strong> project from the data package. The data contains the raw DEM layer and a hillshade layer created from the DEM.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/3d01.png"></p>
<ol>
<li>Let’s create a colorized hillshade. It is possible to drape an image or colorized DEM to a hillshade layer using QGIS’s <strong>Layer Blending Modes</strong>. Click on the <strong>Open the Layer Styling Panel</strong> icon. In the <em>Layer styling</em> panel, choose <code>denali_hillshade</code> and under <em>Layer Rendering</em> choose <strong>Multiply</strong> as <em>Blending mode</em>. The selected layer will be blended with the bottom layer. This is a great way to visualize your elevation dataset.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/3d02.png"></p>
<ol>
<li>Let’s view this data in 3D. Go to <strong>View → New 3D Map View</strong>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/3d03.png"></p>
<ol>
<li>A new map window will open containing the rendered map layers from the main canvas. Click the <strong>Configure</strong> button.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/3d04.png"></p>
<ol>
<li>In the <em>Terrain</em> section, select <strong>DEM (Raster Layer)</strong> as the <em>Type</em>. Select <code>denali_dem</code> layer as the <em>Elevation</em>. Click OK.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/3d05.png"></p>
<ol>
<li>In the 3D view, you can hold the <em>Shift</em> key and drag your mouse to tilt the top-down view. You will see the map in 3D. You can also use the controls on the right-hand panel to tilt, zoom and pan the view.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/3d06.png"></p>
<ol>
<li>Now we will create an animation. Click the <em>Animations</em> button in the toolbar. To animate the view, we must define certain <em>keyframes</em>. Once you define a specific view for keyframes at different times, the system will try to smoothly animate the views between them. You can use the slider to go to a specific time, use the controls to set a specific view and click the <em>+</em> button to add a keyframe. Click the <em>Play</em> button to see the animation in action.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/3d07.png"></p>
<ol>
<li>Once you are satisfied, click the <em>Export Animation Frames</em> button. Choose an output directory on your computer and click OK. Individual frames will be rendered and saved as separate files.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/3d08.png"></p>
<ol>
<li>As we did in the previous section, you can use a service such as <em><a href="https://ezgif.com/maker">ezgif.com</a></em> to create a GIF/Video from these frames.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/3d09.png"></p>
<p><a href="https://courses.spatialthoughts.com/images/advanced_qgis/3d.gif">View Animated GIF ↗</a></p>
<h1>Summary Aggregate Expressions</h1>
<p>QGIS expression engine has a powerful function called ‘summary aggregates’ that allows evaluating a feature’s geometry and attributes with those of another layer. Expressions can be used for static calculations as well as on-the-fly computations, such as labels, virtual fields, symbology etc. This enables some powerful use cases.</p>
<p>The summary aggregate function operates on all the values from a different layer, returning a single summary value. The syntax of the aggregate function is as follows</p>
<div class="highlight"><pre><span></span><code><span class="nx">aggregate</span><span class="p">(</span>
<span class="w">  </span><span class="nx">layer</span><span class="p">:=</span><span class="err">&#39;</span><span class="nx">layer</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="nx">id</span><span class="err">&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">aggregate</span><span class="p">:=</span><span class="err">&#39;</span><span class="nx">aggegate</span><span class="w"> </span><span class="k">type</span><span class="err">&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">expression</span><span class="p">:=</span><span class="err">&#39;</span><span class="nx">expression</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">aggregate</span><span class="err">&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">filter</span><span class="p">:=</span><span class="err">&#39;</span><span class="nx">optional</span><span class="w"> </span><span class="nx">filter</span><span class="w"> </span><span class="nx">expression</span><span class="p">,</span>
<span class="w">  </span><span class="nx">concatenator</span><span class="p">:=</span><span class="err">&#39;</span><span class="nx">optional</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">join</span><span class="w"> </span><span class="nx">values</span><span class="err">&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">order_by</span><span class="p">:=</span><span class="err">&#39;</span><span class="nx">optional</span><span class="w"> </span><span class="nx">expression</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">order</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">features</span><span class="err">&#39;</span>
<span class="w">  </span><span class="p">)</span>
</code></pre></div>

<p><a href="https://docs.google.com/presentation/d/1F-gH729oWv4zcCecXd9BYoNdqHr7KaahgMPm_4XCgBY/edit?usp=sharing">查看幻灯片</a></p>
<h2>练习: Count features from another layer</h2>
<p>We will work with a land parcels data layer provided by the City of San Francisco. The goal of this 练习 is to demonstrate the use of aggregate expression for on-the-fly computation when digitizing new features.</p>
<ol>
<li>Open the <strong>parcels</strong> project from the data package. Select the <code>boundary</code> layer and click the <strong>Open Field Calculator</strong> button.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/aggregate1.png"></p>
<ol>
<li>Add a new field named <code>count</code> with the following expression. The expression is reading the features from the <code>parcels</code> layer and giving an aggregate count of the features. You will notice that the the result will be displayed at the bottom of the window.</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="n">aggregate</span><span class="p">(</span>
<span class="w"> </span><span class="nl">layer:</span><span class="o">=</span><span class="w"> </span><span class="p">&#39;</span><span class="n">parcels</span><span class="p">&#39;,</span>
<span class="w"> </span><span class="nl">aggregate:</span><span class="o">=</span><span class="p">&#39;</span><span class="n">count</span><span class="p">&#39;,</span>
<span class="w"> </span><span class="nl">expression:</span><span class="o">=</span><span class="n">fid</span>
<span class="w"> </span><span class="p">)</span>
</code></pre></div>

<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/aggregate2.png"></p>
<ol>
<li>Now we can apply the same concept in a dynamic calculation. Back in the main QGIS window, select the <code>polygons</code> layer and right-click it. Select <strong>Properties</strong>.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/aggregate3.png"></p>
<ol>
<li>Switch to the <strong>Attributes Form</strong> tab. Select the field <code>count</code> and choose <strong>Text Edit</strong> as the <em>Widget Type</em>. At the <strong>Default Value</strong> field at the bottom, enter the following expression. Note that additional filter value. Here the <code>$geometry</code> refers to the geometry of the <code>parcels</code> layer and <code>geometry(@parent)</code> refers to the geometry of feature from the <code>polygons</code> layer. Click OK.</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">aggregate</span><span class="p">(</span>
<span class="w"> </span><span class="nl">layer</span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;parcels&#39;</span><span class="p">,</span>
<span class="w"> </span><span class="k">aggregate</span><span class="err">:</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span>
<span class="w"> </span><span class="nl">expression</span><span class="p">:</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span>
<span class="w"> </span><span class="k">filter</span><span class="err">:</span><span class="o">=</span><span class="n">intersects</span><span class="p">(</span><span class="err">$</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">geometry</span><span class="p">(</span><span class="nv">@parent</span><span class="p">))</span>
<span class="w"> </span><span class="p">)</span>
</code></pre></div>

<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/aggregate4.png"></p>
<ol>
<li>Back in QGIS, click the <strong>Toggle Editing</strong> button and draw a polygon using the <strong>Add Polygon Feature</strong> button. Right-click to finish the drawing. As soon as you finish, the count of intersecting features will be calculated by the aggregate expression and displayed in the <code>count</code> field.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/aggregate5.png"></p>
<p><a href="https://courses.spatialthoughts.com/images/advanced_qgis/aggregate5.gif">View Animated GIF ↗</a></p>
<ol>
<li>There are many different types of aggregates available. We can use an aggregate called <strong>concatenate</strong> to compute a comma-separated text of all feature ids. Go to the <strong>Attribute Form</strong> properties again and select the <code>parcels</code> field. Enter the following expression as the <strong>Default Value</strong>.</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">aggregate</span><span class="p">(</span>
<span class="w"> </span><span class="nl">layer</span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;parcels&#39;</span><span class="p">,</span>
<span class="w"> </span><span class="k">aggregate</span><span class="err">:</span><span class="o">=</span><span class="s1">&#39;concatenate&#39;</span><span class="p">,</span>
<span class="w"> </span><span class="nl">concatenator</span><span class="p">:</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span>
<span class="w"> </span><span class="nl">expression</span><span class="p">:</span><span class="o">=</span><span class="n">to_string</span><span class="p">(</span><span class="n">fid</span><span class="p">),</span>
<span class="w"> </span><span class="k">filter</span><span class="err">:</span><span class="o">=</span><span class="n">intersects</span><span class="p">(</span><span class="err">$</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">geometry</span><span class="p">(</span><span class="nv">@parent</span><span class="p">))</span>
<span class="w"> </span><span class="p">)</span>
</code></pre></div>

<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/aggregate6.png"></p>
<ol>
<li>Now when to add a new feature, all the intersecting feature ids will be displayed along with the count.</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/aggregate7.png"></p>
<p><a href="https://courses.spatialthoughts.com/images/advanced_qgis/aggregate7.gif">View Animated GIF ↗</a></p>
<h2>Learn more</h2>
<p>Apart from <code>aggregate()</code>, there are other advanced functions such as <code>array_foreach()</code> and <code>eval()</code> that are very powerful. Learn about them in the following video where I explain some use cases.</p>
<p><a href="https://www.youtube.com/watch?v=IXPCec8vgLA"><img alt="Video" src="https://raw.githubusercontent.com/cycleuser/cycleuser.github.io/master/img/QGIS_Advanced/advanced_expressions_qgisna.jpg"></a></p>
<h1>Data Credits</h1>
<ul>
<li>OpenStreetMap (osm) data layers: Data/Maps Copyright 2019 Geofabrik GmbH and OpenStreetMap Contributors. <a href="https://download.geofabrik.de/asia/india.html">OSM India free extract</a> downloaded from Geofabrik.</li>
<li>India State boundary: Downloaded from <a href="https://github.com/datameet/maps/tree/master/States">Datameet Spatial Data repository</a>.</li>
<li>Anti-shipping Activity Messages: <a href="https://msi.nga.mil/NGAPortal/MSI.porta">Maritime Safety Information portal</a> , National Geospatial-Intelligence Agency</li>
<li>Land boundaries: Made with Natural Earth. Free vector and raster map data @ naturalearthdata.com.</li>
<li>Road Network: District of Columbia <a href="https://opendata.dc.gov/">Open Data Catalog</a>.</li>
<li><a href="https://www.usgs.gov/centers/eros/science/usgs-eros-archive-digital-elevation-interferometric-synthetic-aperture-radar">Alaska IFSAR DTM</a> distributed by USGS Earth Resources Observation and Science (EROS), Downloaded from USGS Earth Explorer</li>
<li>Parcels and Neighborhood boundaries downloaded from <a href="https://datasf.org/opendata/">DataSF Open Data Portal</a></li>
</ul>
<h1>授权协议</h1>
<p>本课程材料采用<a href="https://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性4.0国际许可协议</a>授权。你可以为任何非商业目的自由使用该材料。请适当注明原作者的名字。</p>
<p>本中文翻译版本禁止商用。</p>
<p>如果你想利用英文原版内容作为商业产品的一部分，需要 <a href="https://spatialthoughts.com/contact/">联系英文原作者</a> 询问价格和使用条款，获得<em>培训授权</em>，付对应费用。</p>
<p>© 2021 Spatial Thoughts <a href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
    </div><!-- /.entry-content -->
    <footer class="post-meta">
        <span class="meta-prep">Category:</span>
        <abbr class="category">
            <a href="./category/qgis.html">QGIS</a>
        </abbr>
       </footer>
    <section id="respond">
        <div id="disqus_thread">
        <script type="text/javascript">
        var disqus_identifier = "qgis-jin-jie.html";
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://cycleuser.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
        </div>

            

    </section>
</section>


        </section><!-- #content -->
        <section id="widgets" class="grid col-300 fit" >
            <!--
            <section id="widget-search" class="widget-wrapper widget_search">

                <form id="searchform" action="https://www.google.com/search" method="get">
                    <input id="q" class="field" type="text" placeholder="Search Blog" name="q" ></input>
                    <input id="ie" name="ie" type="hidden" value="utf-8" ></input>
                    <input id="oe" name="oe" type="hidden" value="utf-8" ></input>
                    <input id="channel" name="channel" type="hidden" value="suggest" ></input>
                    <input id="searchsubmit" class="submit" type="submit" value="">
                </form>
            </section>
            -->
            <section id="widget-category" class="widget-wrapper widget_archive">
                <div class="widget-title">
                    Category
                </div>
                <ul>
                        <li><a href="./category/camera.html" >Camera </a></li>
                        <li><a href="./category/chromebook.html" >ChromeBook </a></li>
                        <li><a href="./category/diy.html" >DIY </a></li>
                        <li><a href="./category/duke.html" >Duke </a></li>
                        <li><a href="./category/fuckzhihu.html" >FuckZhihu </a></li>
                        <li><a href="./category/hackintosh.html" >Hackintosh </a></li>
                        <li><a href="./category/linux.html" >Linux </a></li>
                        <li><a href="./category/mac.html" >Mac </a></li>
                        <li><a href="./category/nas.html" >NAS </a></li>
                        <li><a href="./category/photography.html" >Photography </a></li>
                        <li><a href="./category/python.html" >Python </a></li>
                        <li><a href="./category/qgis.html" >QGIS </a></li>
                        <li><a href="./category/qt.html" >QT </a></li>
                        <li><a href="./category/raspbian.html" >Raspbian </a></li>
                        <li><a href="./category/sdr.html" >SDR </a></li>
                        <li><a href="./category/software.html" >Software </a></li>
                        <li><a href="./category/story.html" >Story </a></li>
                        <li><a href="./category/virtualization.html" >Virtualization </a></li>
                        <li><a href="./category/work.html" >Work </a></li>
                </ul>
            </section>

            <section id="widget-tagcloud" class="widget-wrapper widget_archive">
                <div class="widget-title">
                    Tagcloud
                </div>
                <div>
                        <span><a href="./tag/vispy.html">VisPy</a></span>
                        <span><a href="./tag/fuckchunwan.html">FuckChunWan</a></span>
                        <span><a href="./tag/book.html">Book</a></span>
                        <span><a href="./tag/raspbian.html">Raspbian</a></span>
                        <span><a href="./tag/hadoop.html">Hadoop</a></span>
                        <span><a href="./tag/geology.html">Geology</a></span>
                        <span><a href="./tag/learning.html">Learning</a></span>
                        <span><a href="./tag/science.html">Science</a></span>
                        <span><a href="./tag/python.html">Python</a></span>
                        <span><a href="./tag/chat.html">Chat</a></span>
                        <span><a href="./tag/camera.html">Camera</a></span>
                        <span><a href="./tag/telescope.html">Telescope</a></span>
                        <span><a href="./tag/memory.html">Memory</a></span>
                        <span><a href="./tag/game.html">Game</a></span>
                        <span><a href="./tag/mac.html">Mac</a></span>
                        <span><a href="./tag/chromebook.html">ChromeBook</a></span>
                        <span><a href="./tag/qemu.html">QEMU</a></span>
                        <span><a href="./tag/ide.html">IDE</a></span>
                        <span><a href="./tag/virtualization.html">Virtualization</a></span>
                        <span><a href="./tag/kivy.html">Kivy</a></span>
                        <span><a href="./tag/gis.html">GIS</a></span>
                        <span><a href="./tag/qgis.html">QGIS</a></span>
                        <span><a href="./tag/disease.html">Disease</a></span>
                        <span><a href="./tag/raspberrypi.html">RaspberryPi</a></span>
                        <span><a href="./tag/linux.html">Linux</a></span>
                        <span><a href="./tag/lesson.html">Lesson</a></span>
                        <span><a href="./tag/story.html">Story</a></span>
                        <span><a href="./tag/qt.html">QT</a></span>
                        <span><a href="./tag/moon.html">Moon</a></span>
                        <span><a href="./tag/hardware.html">Hardware</a></span>
                        <span><a href="./tag/phd.html">PHD</a></span>
                        <span><a href="./tag/shit.html">Shit</a></span>
                        <span><a href="./tag/visualization.html">Visualization</a></span>
                        <span><a href="./tag/programming.html">Programming</a></span>
                        <span><a href="./tag/scholar.html">Scholar</a></span>
                        <span><a href="./tag/photo.html">Photo</a></span>
                        <span><a href="./tag/library.html">Library</a></span>
                        <span><a href="./tag/hack.html">Hack</a></span>
                        <span><a href="./tag/vtk.html">VTK</a></span>
                        <span><a href="./tag/video.html">Video</a></span>
                        <span><a href="./tag/data.html">Data</a></span>
                        <span><a href="./tag/virtualbox.html">VirtualBox</a></span>
                        <span><a href="./tag/university.html">University</a></span>
                        <span><a href="./tag/mountblade.html">Mount&Blade</a></span>
                        <span><a href="./tag/rtl-sdr.html">RTL-SDR</a></span>
                        <span><a href="./tag/microscope.html">Microscope</a></span>
                        <span><a href="./tag/hate.html">Hate</a></span>
                        <span><a href="./tag/fckzhihu.html">FckZhiHu</a></span>
                        <span><a href="./tag/hbase.html">HBase</a></span>
                        <span><a href="./tag/photography.html">Photography</a></span>
                        <span><a href="./tag/cuda.html">CUDA</a></span>
                        <span><a href="./tag/nas.html">NAS</a></span>
                        <span><a href="./tag/pyenv.html">Pyenv</a></span>
                        <span><a href="./tag/junck.html">Junck</a></span>
                        <span><a href="./tag/life.html">Life</a></span>
                        <span><a href="./tag/conda.html">Conda</a></span>
                        <span><a href="./tag/hackintosh.html">Hackintosh</a></span>
                        <span><a href="./tag/diy.html">DIY</a></span>
                        <span><a href="./tag/radio.html">Radio</a></span>
                        <span><a href="./tag/discuss.html">Discuss</a></span>
                        <span><a href="./tag/opencl.html">OpenCL</a></span>
                        <span><a href="./tag/server.html">Server</a></span>
                        <span><a href="./tag/xcode.html">Xcode</a></span>
                        <span><a href="./tag/fuckzhihu.html">FuckZhihu</a></span>
                        <span><a href="./tag/translation.html">Translation</a></span>
                        <span><a href="./tag/communicate.html">Communicate</a></span>
                        <span><a href="./tag/mayavi.html">MayaVi</a></span>
                        <span><a href="./tag/software.html">Software</a></span>
                        <span><a href="./tag/translate.html">Translate</a></span>
                        <span><a href="./tag/poem.html">Poem</a></span>
                        <span><a href="./tag/macos.html">macOS</a></span>
                        <span><a href="./tag/download.html">Download</a></span>
                        <span><a href="./tag/geopython.html">GeoPython</a></span>
                        <span><a href="./tag/lens.html">Lens</a></span>
                        <span><a href="./tag/pyopencl.html">PyOpenCL</a></span>
                        <span><a href="./tag/glumpy.html">GlumPy</a></span>
                </div>
            </section>


            <section id="widget-links" class="widget-wrapper widget_archive">
                <div class="widget-title">
                    Links
                </div>
                <ul>
                        <li><a href="https://chinageology.com">ChinaGeology</a></li>
                        <li><a href="http://doc.geopython.com/">GeoPython</a></li>
                        <li><a href="https://fanzheng.org">Fan</a></li>
                        <li><a href="http://o00o.site">FlagPlus</a></li>
                        <li><a href="http://blog.cosli.top">CosLi</a></li>
                        <li><a href="http://akagi201.org">Akagi201</a></li>
                        <li><a href="http://xuanwo.org/">XuanWo</a></li>
                        <li><a href="https://blog.daftme.com">4Orange</a></li>
                        <li><a href="http://blog.riverrun.xyz/">River</a></li>
                        <li><a href="https://www.logcg.com">LogCG Blog</a></li>
                        <li><a href="http://guolao.me/">GuoLao</a></li>
                </ul>
            </section>
            
        </section><!-- widgets -->
    </section><!-- /#wrapper -->
    <footer id="footer" class="clearfix"><section class="footer-wrapper">
        <div class="grid col-940" >
            <div class="grid col-540"></div>
            <div class="grid col-380 fit" >
                <ul class="social-icons">
                    <!-- TO BE CONTINUED -->
                </ul>
            </div>
        </div>

        <div class="grid col-300 copyright" >
            <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="license">
                <img src="https://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" style="border-width:0" alt="知识共享许可协议"></img>
            </a>
        </div>
        <div class="grid col-300 ">

        </div>
        <div class="grid col-300 fit powered">
            Powered by <a href="https://getpelican.com/">Pelican</a> <br />
            which takes great advantage of <a href="https://python.org">Python</a>
        </div>
    </section></footer>
</div>
</body>
</html>